{% extends "base.html" %}

{% block title %}{{ title }} - Wikipedia Voice Assistant{% endblock %}

{% block content %}
<div class="mb-3">
  <a href="{{ url_for('index') }}" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-2"></i>Back to Search
  </a>
</div>

<div class="text-center mb-4">
  <h1 class="display-5 fw-bold mb-3">{{ title }}</h1>
  <div class="d-flex justify-content-center gap-2 flex-wrap">
    <span class="badge bg-primary">
      <i class="fas fa-book me-1"></i>Wikipedia Article
    </span>
    <span class="badge bg-success">
      <i class="fas fa-volume-up me-1"></i>Audio Available
    </span>
    <span class="badge bg-danger">
      <i class="fas fa-file-pdf me-1"></i>PDF Ready
    </span>
  </div>
</div>

<div class="row">
  <div class="col-lg-8">
    <!-- Wikipedia Summary -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-info-circle text-primary me-2"></i>
          Wikipedia Summary
        </h5>
      </div>
      <div class="card-body">
        <p class="mb-0">{{ summary }}</p>
      </div>
    </div>

    <!-- AI Summary -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-robot text-success me-2"></i>
          AI-Generated Summary
        </h5>
      </div>
      <div class="card-body">
        <p class="mb-0">{{ ai_summary }}</p>
      </div>
    </div>

    <!-- Full Article Content -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-file-text text-secondary me-2"></i>
          Full Article Content
        </h5>
      </div>
      <div class="card-body">
        <div style="max-height: 400px; overflow-y: auto; padding: 1rem; background: var(--background-secondary); border-radius: var(--radius-md);">
          {{ content|replace('\n', '<br />')|safe }}
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <!-- Audio Player Section -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-volume-up text-primary me-2"></i>
          Audio Player
        </h5>
      </div>
      <div class="card-body">
        <div id="audio-loading" class="text-center py-4">
          <div class="loading-spinner mx-auto mb-3"></div>
          <p class="text-muted mb-0">Generating audio, please wait...</p>
        </div>

        <div id="audio-player-section" style="display: none;">
          <audio id="main-audio-player" controls class="w-100 mb-3">
            <source src="{{ url_for('stream_audio', file_id=file_id) }}" type="audio/wav" />
            Your browser does not support the audio element.
          </audio>

          <div class="audio-controls mb-3">
            <button id="play-pause-btn" class="btn btn-primary btn-sm">
              <i class="fas fa-play me-1"></i>Play
            </button>
            <button id="stop-btn" class="btn btn-warning btn-sm">
              <i class="fas fa-stop me-1"></i>Stop
            </button>
            <button id="speed-btn" class="btn btn-info btn-sm" data-speed="1">
              <i class="fas fa-tachometer-alt me-1"></i>1x
            </button>
          </div>

          <div class="mb-3">
            <label for="volume-control" class="form-label">
              <i class="fas fa-volume-down me-1"></i>Volume
            </label>
            <input type="range" class="form-range" id="volume-control" min="0" max="100" value="80">
          </div>
        </div>
      </div>
    </div>

    <!-- Download Section -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-download text-success me-2"></i>
          Downloads
        </h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <button id="download-audio-btn" class="btn btn-success" disabled>
            <i class="fas fa-file-audio me-2"></i>
            Download Audio
          </button>
          <a href="{{ url_for('download_pdf', title=title, content=content) }}" class="btn btn-danger">
            <i class="fas fa-file-pdf me-2"></i>
            Download PDF
          </a>
        </div>
        <div class="mt-3 p-3 bg-light rounded">
          <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            Audio files are in WAV format. PDF includes the complete article content.
          </small>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let audioPlayer = null;
  let isPlaying = false;
  let currentSpeed = 1;

  function checkAudioReady() {
    fetch("/check_audio/{{ file_id }}")
      .then(response => response.json())
      .then(data => {
        if (data.ready) {
          showAudioPlayer();
        } else {
          setTimeout(checkAudioReady, 2000);
        }
      })
      .catch(error => {
        console.error("Error checking audio status:", error);
        setTimeout(checkAudioReady, 3000);
      });
  }

  function showAudioPlayer() {
    document.getElementById("audio-loading").style.display = "none";
    document.getElementById("audio-player-section").style.display = "block";
    document.getElementById("download-audio-btn").disabled = false;

    audioPlayer = document.getElementById("main-audio-player");
    setupAudioControls();
  }

  function setupAudioControls() {
    const playPauseBtn = document.getElementById("play-pause-btn");
    const stopBtn = document.getElementById("stop-btn");
    const speedBtn = document.getElementById("speed-btn");
    const volumeControl = document.getElementById("volume-control");
    const downloadBtn = document.getElementById("download-audio-btn");

    playPauseBtn.addEventListener("click", function() {
      if (isPlaying) {
        audioPlayer.pause();
        playPauseBtn.innerHTML = '<i class="fas fa-play me-1"></i>Play';
        playPauseBtn.className = "btn btn-primary btn-sm";
        isPlaying = false;
      } else {
        audioPlayer.play();
        playPauseBtn.innerHTML = '<i class="fas fa-pause me-1"></i>Pause';
        playPauseBtn.className = "btn btn-success btn-sm";
        isPlaying = true;
      }
    });

    stopBtn.addEventListener("click", function() {
      audioPlayer.pause();
      audioPlayer.currentTime = 0;
      playPauseBtn.innerHTML = '<i class="fas fa-play me-1"></i>Play';
      playPauseBtn.className = "btn btn-primary btn-sm";
      isPlaying = false;
    });

    speedBtn.addEventListener("click", function() {
      const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
      const currentIndex = speeds.indexOf(currentSpeed);
      const nextIndex = (currentIndex + 1) % speeds.length;
      currentSpeed = speeds[nextIndex];

      audioPlayer.playbackRate = currentSpeed;
      speedBtn.innerHTML = `<i class="fas fa-tachometer-alt me-1"></i>${currentSpeed}x`;
    });

    volumeControl.addEventListener("input", function() {
      audioPlayer.volume = this.value / 100;
    });

    audioPlayer.volume = 0.8;

    audioPlayer.addEventListener("ended", function() {
      playPauseBtn.innerHTML = '<i class="fas fa-play me-1"></i>Play';
      playPauseBtn.className = "btn btn-primary btn-sm";
      isPlaying = false;
    });

    downloadBtn.addEventListener("click", function() {
      window.location.href = '{{ url_for("download_audio") }}?title={{ title|urlencode }}&content={{ content|urlencode }}';
    });
  }

  document.addEventListener("DOMContentLoaded", function() {
    checkAudioReady();
  });

  // Keyboard shortcuts
  document.addEventListener("keydown", function(event) {
    if (audioPlayer && document.getElementById("audio-player-section").style.display !== "none") {
      switch (event.code) {
        case "Space":
          event.preventDefault();
          document.getElementById("play-pause-btn").click();
          break;
        case "KeyS":
          event.preventDefault();
          document.getElementById("stop-btn").click();
          break;
      }
    }
  });
</script>
{% endblock %}